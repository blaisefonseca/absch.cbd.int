<div id="SubmitPage" ng-controller="registerRecordList">
    <link href="/app/css/register.css" rel="stylesheet">
    <link href="/app/css/record.css" rel="stylesheet">

    <span register-top-menu></span>

    <div class="card card-1-notrans">
        <span record-type-header></span>

        <div class="register-content-content">
            <div ng-show="msg" class="alert alert-success alert-dismissable">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true" ng-click="msg=''">&times;</button>
                <strong>{{msg}}</strong>
            </div>
            <div class="row">
                <div class="col-xs-8">
                    <div class="btn-group-sm">
                        <button type="button" ng-click="statusFilter=''" class="filterbtn btn btn-primary">
                        <i  class="fa fa-2 fa-square" ng-class="{'fa-check-square':!statusFilter}"></i>
                        <strong>All</strong> <span class="badge badge-default">{{(records||[]).length}}</span>
                    </button>
                        <button type="button" ng-click="statusFilter=isRequest" class="filterbtn btn btn-danger">
                        <i class="fa fa-2 fa-square" ng-class="{'fa-check-square':statusFilter==isRequest}"></i> 
                        Requests
                        <span class="badge badge-default">{{(records | filter:schemaFilter | filter:isRequest).length}}</span>
                    </button>
                        <button type="button" ng-click="statusFilter=isPublished" class="filterbtn btn btn-success">
                        <i  class="fa fa-2 fa-square"  ng-class="{'fa-check-square':statusFilter==isPublished}"></i> Published
                        <span class="badge badge-default">{{(records | filter:schemaFilter | filter:isPublished).length}}</span>
                    </button>
                        <button type="button" ng-click="statusFilter=isDraft" class="filterbtn btn btn-draft">
                        <i class="fa fa-2 fa-square" ng-class="{'fa-check-square':statusFilter==isDraft}"></i> Drafts
                        <span class="badge badge-default">{{(records | filter:schemaFilter | filter:isDraft).length}}</span>
                    </button>
                        <input type="text" ng-model="keywords" placeholder=" Keyword " class="form-control keyword input-group" style="width:160px;display:inline;font-size:12px;height:31px;">
                    </div>

                </div>
                <div class="col-xs-4 " ng-show="showAddButton()">
                    <div class="btn-group-sm pull-right">
                        <!--<a ng-href="#" class="btn btn-sm btn-primary" ng-click="showReference(schema);">
                        <span class="glyphicon glyphicon-random"></span> Show Reference</a>-->
                        <a href="#" class="btn btn-sm btn-primary color-white" ng-click="refreshList(schema);" style="color:#fff;">
                            <i class="fa fa-refresh"></i> Refresh</a>
                        <a ng-href="/register/{{schema|schemaShortName}}/new" class="btn btn-sm btn-primary" style="color:#fff;" id="new_button">
                            <i class="fa fa-plus-square"></i> Add New </a>
                    </div>
                </div>
            </div>

            <table class="table table-hover table-striped" style="width:100%;margin-top:20px;">
                <thead>
                    <tr>
                        <th ng-click="toggleOrderBy('title|lstring')" id="titleHeader">Title</th>
                        <th ng-if="schema=='contact'" ng-click="toggleOrderBy('body.type')" id="body.typeHeader">Type</th>
                        <th style="width:200px;" ng-click="toggleOrderBy('SubmittedBy')" id="createdOnHeader">Last published</th>
                        <th style="width:200px;" ng-click="toggleOrderBy('updatedOn')" id="updatedOnHeader">Last updated</th>
                        <th style="width:150px;" ng-click="toggleOrderBy('status')" id="statusHeader">Status</th>
                        <th style="width:100px;">{{filteredRecords.length}} Record(s)</th>
                    </tr>
                </thead>
                <tr ng-cloak ng-show="loading">
                    <td colspan="6" style="text-align:center;padding:30px;"><i class="fa fa-spin fa-cog" /> loading...</td>
                </tr>
                <tr ng-cloak ng-show="!loading && filteredRecords.length <= 0">
                    <td colspan="6" style="text-align:center;padding:30px;"> <strong>No records found.</strong></td>
                </tr>

                <tbody ng-repeat="record in (filteredRecords = (records | filter:schemaFilter | filter:statusFilter | filter:keywords | orderBy:orderBy))">

                    <tr id="record{{record.identifier}}" ng-class="{'bg-grey': displayDetails||displayRequest}">

                        <td style="width:40%; padding-left:10px;">
                            <span ng-show="isPublished(record)">
                            <a ng-href="/register/{{record.type|schemaShortName}}/{{record.identifier}}/view" ng-show="record.documentID">
                                {{(record.workingDocumentTitle||record.title)|lstring}}
                            </a>
                        </span>
                            <span ng-show="isRequest(record)">
                            <a ng-href="/register/{{record.type|schemaShortName}}/{{record.identifier}}/view">
                                {{(record.workingDocumentTitle||record.title)|lstring}}
                            </a>
                        </span>

                            <span ng-show="isDraft(record) && !isPublished(record) && !isRequest(record)">
                            <a href="/register/{{record.type|schemaShortName}}/{{record.identifier}}/edit">
                                {{(record.workingDocumentTitle||record.title)|lstring}}
                            </a>
                        </span>
                            <div style="font-size:11px;font-weight:bold;text-transform:uppercase;color:#666;" ng-if="isPublished(record)">
                                {{record | uniqueID}} <span ng-show="isDraft(record) || isRequest(record)" class="label label-primary">draft</span>
                            </div>
                        </td>
                        <td ng-if="schema=='contact'">
                            <span style="font-size:11px;font-weight:500;text-transform:uppercase;padding:4px 10px 4px 4px;color:#666">{{record.body.type}}</span>
                        </td>
                        <td>
                            <div ng-if="record.updatedBy && isPublished(record)">
                                <a style="color:#666" href="mailto:{{record.updatedBy.email}}">
                                    <strong>{{record.updatedBy.firstName}} {{record.updatedBy.lastName}}</strong>
                                </a>
                                </br>
                                <span style="font-size:10px;white-space:nowrap;">{{record.updatedOn | formatDateWithTime }}</span>
                            </div>
                            <div ng-if="record.createdBy && !record.updatedBy && isPublished(record)">
                                <a style="color:#666" href="mailto:{{record.createdBy.email}}">
                                    <strong>{{record.createdBy.firstName}} {{record.createdBy.lastName}}</strong>
                                </a>
                                </br>
                                <span style="font-size:10px;white-space:nowrap;">{{record.createdOn | formatDateWithTime }}</span>
                            </div>
                        </td>
                        <td>
                            <div ng-if="record.workingDocumentUpdatedBy">
                                <a style="color:#666" href="mailto:{{record.workingDocumentUpdatedBy.email}}">
                                    <strong>{{record.workingDocumentUpdatedBy.firstName}} {{record.workingDocumentUpdatedBy.lastName}}</strong>
                                </a>
                                </br>
                                <span style="font-size:10px;white-space:nowrap;">{{record.workingDocumentUpdatedOn | formatDateWithTime }}</span>
                            </div>
                            <div ng-if="record.workingDocumentCreatedBy && !record.workingDocumentUpdatedBy">
                                <a style="color:#666" href="mailto:{{record.workingDocumentCreatedBy.email}}">
                                    <strong>{{record.workingDocumentCreatedBy.firstName}} {{record.workingDocumentCreatedBy.lastName}}</strong>
                                </a>
                                </br>
                                <span style="font-size:10px;white-space:nowrap;">{{record.workingDocumentCreatedBy | formatDateWithTime }}</span>
                            </div>
                            <div ng-if="!record.workingDocumentCreatedBy && !record.workingDocumentUpdatedBy">
                                <div ng-show="record.updatedBy">
                                    <a style="color:#666" href="mailto:{{record.updatedBy.email}}">
                                        <strong>{{record.updatedBy.firstName}} {{record.updatedBy.lastName}}</strong>
                                    </a>
                                    </br>
                                    <span style="font-size:10px;white-space:nowrap;">{{record.updatedOn | formatDateWithTime }}</span>
                                </div>
                                <div ng-show="record.createdBy && !record.updatedBy">
                                    <a style="color:#666" href="mailto:{{record.createdBy.email}}">
                                        <strong>{{record.createdBy.firstName}} {{record.createdBy.lastName}}</strong>
                                    </a>
                                    </br>
                                    <span style="font-size:10px;white-space:nowrap;">{{record.createdOn | formatDateWithTime }}</span>
                                </div>
                            </div>
                        </td>
                        <td>

                            <div ng-show="!record.revoked && isPublished(record) && !isRequest(record)" class="color-published-green bold"> Published </div>
                            <div ng-show="!record.revoked && isDraft(record) && !isRequest(record)" class="color-litegrey bold"> Draft </div>
                            <div ng-show="!record.revoked && isRequest(record) && !record.isUpdating && !isPublishingAuthority(record)" class="color-red bold"> Pending approval </div>
                            <span class="color-red bold" ng-show="record.revoked">Revoked</span>
                            <a class="btn btn-danger color-white" ng-show="!record.revoked && isRequest(record) && !record.isUpdating && isPublishingAuthority(record)" ng-href="/register/{{record.metadata.schema | schemaShortName}}/{{record.identifier}}/view">
                                Pending approval
                            </a>
                            <div ng-show="!record.revoked && isRequest(record) && record.isUpdating">
                                <a class="btn btn-info" type="button" ng-click="return" style="padding:4px;">
                                    <strong><i class="fa fa-spin fa-cog"></i> Processing...</strong>
                                </a>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group document_buttons btn-group-sm" style="width:100px;">
                                <button ng-show="showAddButton()" title="Duplicate" type="button" class="btn btn-default" ng-click="askDuplicate(record)"><i class="fa fa-files-o"></i></button>
                                <button title="Locked for edit" ng-show="!record.revoked && isRequest(record) && showAddButton()" type="button" class="btn btn-default"><i class="glyphicon glyphicon-lock"></i></button>
                                <button title="Cancel request" ng-show="!record.revoked && isRequest(record) && showAddButton() && isMyRecord(record)" type="button" class="btn btn-default" ng-click="askDeleteWorkflowRequest(record)"><i class="fa fa-undo"></i></button>
                                <a title="Edit" ng-show="!record.revoked && !isRequest(record) && showAddButton()" type="button" class="btn btn-default" href="/register/{{record.type|schemaShortName}}/{{record.identifier}}/edit"><i class="fa fa-edit"></i></a>
                                <button title="Delete" ng-show="!record.revoked && !isRequest(record) && showAddButton()" ng-class="{'red':(record.type == 'absPermit' && isPublished(record))}" type="button" class="btn btn-default" ng-click="askDelete(record)"><i class="fa fa-trash-o"></i></button>
                            </div>
                        </td>
                    </tr>
                    <tr ng-if="displayReference && record.body && record.body.badRevisions && record.body.badRevisions.length > 0" style="border:0!important;background-color:inherit!important;" ng-class="{'bg-grey': displayReference}">
                        <td colspan="6" style="border:0!important;">

                            <div ng-show="displayReference" block-region activate=" loading">

                                <div class="btn-group-sm pull-right">
                                    <a ng-href="#" class="btn btn-sm btn-primary" ng-click="loading = !loading">
                                        <span class="glyphicon glyphicon-random"></span> Update</a>
                                </div>
                                <table class="table table-striped" style="width:100%">
                                    <thead>
                                        <tr>
                                            <td> Field </td>
                                            <td>Field Current Revision</td>
                                            <td>Reference Record Revision</td>
                                            <td></td>
                                        </tr>
                                    </thead>
                                    <tr ng-repeat="badRevision in record.body.badRevisions">
                                        <td>
                                            {{badRevision.field}}
                                        </td>
                                        <td>{{badRevision.fieldRevision}}
                                        </td>
                                        <td>
                                            {{badRevision.currentRevision}}
                                        </td>
                                        <td>
                                            <a ng-href="#" class="btn btn-sm btn-primary" ng-click="updateReference(record,badRevision.field);">
                                                <span class="glyphicon glyphicon-random"></span> Update {{badRevision.field}}</a>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div id="deleteRecordModel" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">What do you want to delete? <i ng-show="loading" class="fa fa-spinner fa-spin"></i></h4>
                        </div>
                        <div class="modal-body" ng-hide="cantDelete || iacCantDelete">

                            <div ng-show="isDraft(recordToDelete)" class="well">
                                <button type="button" class="btn btn-warning pull-right" ng-disabled="loading" ng-click="deleteDraft(recordToDelete)">Delete the draft</button>
                                <em>Draft {{recordToDelete.documentID||'[new]'}}</em>
                                <p><b>{{recordToDelete.workingDocumentTitle|lstring}}</b></p>
                                <p ng-bind-html="recordToDelete.workingDocumentSummary|lstring"></p>
                            </div>

                            <div ng-show="isPublished(recordToDelete)" class="well">
                                <button type="button" class="btn btn-danger pull-right" ng-disabled="loading" ng-click="deleteRecord(recordToDelete)" data-toggle="tooltip" data-placement="top" title="Note: Any pending draft will also be deleted">
                                Unpublish and delete the record</button>
                                <em>Published record {{recordToDelete.documentID}}</em>
                                <p><b>{{recordToDelete.title|lstring}}</b></p>
                                <p ng-bind-html="recordToDelete.summary|lstring"></p>
                            </div>

                        </div>
                        <div class="modal-body" ng-show="cantDelete || pilotDelete">
                            <div ng-show="isPublished(recordToDelete)" class="well">
                                <span class="label label-info">Not allowed to delete published ABSCH-IRCC records.
                                    <i>Revoked</i> IRCC records are no longer valid.
                                </span></br>
                                <p><b>{{recordToDelete.title|lstring}}</b> {{recordToDelete | uniqueIDWithoutRevision}}</p>
                                <p ng-bind-html="recordToDelete.summary|lstring"></p>
                                <hr/>
                                <div km-form-languages ng-model="recordToDelete.document.header.languages" style="padding-top:20px;padding-left:0px;" class="pull-left btn-xs"></div></br></br></br>
                                <div class="km-control-group"> 
                                    <div class="km-control-group" name="amendmentDescription" required caption="Provide a summary of the reason for revoking this IRCC">
                                        <div km-textbox-ml ng-model="recordToDelete.document.amendmentDescription" rows="3" placeholder="" locales="recordToDelete.document.header.languages" />
                                    </div>
                                </div>
                                <button type="button" class="btn btn-danger" ng-disabled="loading" ng-click="revokeRecord(recordToDelete)">
                                    Revoke this IRCC
                                </button></br></br>
                                <div class="alert alert-danger" ng-if="recordToDelete.showRevokeError">Please enter a summary of the reason for revoking this IRCC</div> 
                            </div>
                        </div>
                        <div class="modal-body" ng-show="iacCantDelete">

                            You do not have sufficient privileges to delete document.

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>

            <div id="duplicateRecordModel" class="modal fade" data-backdrop="static">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4>Duplicate record<i ng-show="loading" class="fa fa-spinner fa-spin"></i></h4>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to duplicate this record, this will create a new draft record with same details?</p>
                        </div>
                        <div class="modal-footer" style="margin-top:0">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button ng-disabled="loading" type="button" ng-click="duplicate(recordToDuplicate)" class="btn btn-primary">Yes</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="deleteWorkflowRequestModal" class="modal fade" data-backdrop="static">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4>Cancel publishing request<i ng-show="loading" class="fa fa-spinner fa-spin"></i></h4>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to cancel this publishing request?</p>
                        </div>
                        <div class="modal-footer" style="margin-top:0">
                            <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
                            <button ng-disabled="loading" type="button" ng-click="deleteWorkflowRequest(recordForDeleteWorkflowRequest)" class="btn btn-primary">Yes</button>

                        </div>
                    </div>
                </div>
            </div>



        </div>


    </div>
</div>